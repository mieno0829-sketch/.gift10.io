<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>自動車保険 更新手続き（完全版・修正版・保存用）</title>
<!-- Version: full-2025-11-14-stable-a11y-progress25-time-history-noticeLink-header2rows-faq-bluePlayIcon-pressChip-mobileHighlight-2025-11-14h -->
<style>
  :root {
    --blue-900:#0f3d7a; --blue-700:#1f5fbf; --blue-500:#3c7fe6;
    --bg:#f5f7fb; --card:#ffffff; --text:#1a1a1a; --sub:#445066; --border:#d7e0f0;
    --orange:#e86f00; --orange-700:#c95f00; --alert:#b00020; --safe:#0b7a3e; --purple:#6f42c1;
    --curBg:#eef7ff; --newBg:#eef9f1; --deltaBg:#fff7e6; --red:#a00000; --yellow:#ffec99;
    --face:#e0f2ff; --face-border:#90caf9;
  }
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--text);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    background: linear-gradient(160deg, #f9fbff 0%, #eef3fb 55%, #eaf0fa 100%);
    background-attachment: fixed;
  }
  @media (prefers-color-scheme:dark){
    body{ background: linear-gradient(160deg, #161b23 0%, #1b2330 60%, #1f2a3a 100%); }
  }

  .wrap{max-width:430px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}

  header{
    position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);
    padding:6px 10px;display:flex;flex-direction:column;gap:6px;z-index:10
  }
  .headerTop{display:flex;align-items:center;justify-content:space-between;gap:6px}
  .toolbar{display:flex;gap:6px;align-items:center}
  header .btn{font-size:13px;color:var(--blue-700);text-decoration:none;padding:4px 6px}
  .toggleLarge{border:1px solid var(--border);border-radius:6px;padding:4px 8px;background:#fff;color:var(--blue-900);cursor:pointer;font-size:13px}
  .aiAgent{display:flex;align-items:center;gap:6px;cursor:pointer}
  .aiRobot{width:28px;height:28px;border-radius:8px;background:
    radial-gradient(circle at 9px 11px,#fff 4px,#3c7fe6 5px,#3c7fe6 9px,transparent 10px),
    radial-gradient(circle at 19px 11px,#fff 4px,#3c7fe6 5px,#3c7fe6 9px,transparent 10px),
    linear-gradient(180deg,#6f42c1,#3c7fe6);
    border:2px solid #d7e0f0}
  .aiLabel{font-size:12px;color:var(--blue-900)}

  .progress{padding:6px 0 2px 0;font-size:12px;color:var(--blue-900);display:grid;gap:4px;background:#fff}
  .bar{height:8px;background:#e8eefb;border-radius:999px;overflow:hidden}
  .bar div{ height:8px;background:var(--blue-700);width:0%;transition:width .25s ease-out;border-radius:999px; }

  main{flex:1;padding-bottom:90px}
  .screen{display:none}.screen.active{display:block}

  :root { --sp-8:8px; --sp-12:12px; --sp-16:16px; }

  .card{
    background:#fff;margin: var(--sp-12) var(--sp-12); padding: var(--sp-12); border-radius:12px;
    box-shadow:0 2px 8px rgba(15,61,122,.08); border:1px solid var(--border)
  }
  .card + .card{ margin-top: var(--sp-16); }

  .h1{ font-size:16px; font-weight:600; color:var(--blue-900); margin-top:0; margin-bottom:var(--sp-8); letter-spacing:.01em; }
  .desc{font-size:13px;color:var(--sub);line-height:1.55; letter-spacing:.01em;}
  .list,.item{font-size:13px;color:#222;line-height:1.55;margin: var(--sp-8) 0; letter-spacing:.005em;}
  .field{margin-top: var(--sp-12)}
  .label{font-size:13px;color:var(--blue-900);margin-bottom: var(--sp-8)}
  .input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:#fff}
  .input:focus,select:focus,textarea:focus{outline:2px solid var(--blue-500);border-color:var(--blue-500)}
  .btnPrimary{
    display:block;width:100%;padding:12px;border-radius:12px;font-size:15px;font-weight:700;text-align:center;border:none;cursor:pointer;margin-top:10px;background:#e86f00;color:#fff;
    transition:transform .06s ease, box-shadow .12s ease; box-shadow:0 2px 0 rgba(15,61,122,.08);
  }
  .btnPrimary:active{background:#c95f00}
  .link{color:var(--blue-700);text-decoration:none;font-size:13px}
  .blockLink{display:inline-block;margin-top:6px}
  .redNote{color:var(--red);font-size:12px;margin-top:4px}

  .priceTable{width:100%;border-collapse:collapse;margin-top: var(--sp-8)}
  .priceTable th, .priceTable td{border:1px solid var(--border);padding:8px;font-size:13px;text-align:right}
  .priceTable th{background:#f6f8fc;color:var(--blue-900);text-align:center}
  .rowLabel{width:28%;text-align:left;background:#f9fafc;color:var(--blue-900);font-weight:700}
  .rowCurrent{background:var(--curBg)} .rowNew{background:var(--newBg)} .rowDelta{background:var(--deltaBg)}
  .dpos{color:var(--safe);font-weight:700} .dneg{color:var(--alert);font-weight:700}

  .colorRow{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .colorBtn{display:flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--blue-700);background:#fff;color:var(--blue-700);border-radius:10px;cursor:pointer;flex:1}
  .colorBtn.active{outline:2px solid var(--blue-700);background:#eef4ff}
  .swatch{width:16px;height:16px;border-radius:4px;border:1px solid #ccc}
  .gold{background:#ffd54f} .blue{background:#3c7fe6} .green{background:#0b7a3e}

  .infoRow{display:flex;align-items:center;gap:8px;margin-top:8px}
  :root { --icon:20px; }
  .infoIcon{ width:var(--icon); height:var(--icon); border-radius:50%; background:var(--yellow); color:#1a1a1a;
    display:inline-flex; align-items:center; justify-content:center; font-weight:700; font-size:12px; border:1px solid #e0c24f; }
  .videoIcon{ width:var(--icon); height:var(--icon); }
  .aiRobot{ border-radius:8px; }
  .videoCta{ line-height:1.35; }

  .foldCard{border:1px solid var(--border);border-radius:12px;padding: var(--sp-12);background:#fff;margin: var(--sp-12) 0;}
  .foldCard .foldHeader{ font-weight:600; color:var(--blue-900); padding-bottom: var(--sp-8); border-bottom:1px solid rgba(215,224,240,0.8); }
  .foldCard .foldBody{ margin-top: var(--sp-8); }
  .foldCard .foldSub{ font-size:12px; color:var(--sub); margin-top: var(--sp-8); line-height:1.55; }
  @media (prefers-color-scheme:dark){ .foldCard .foldHeader{ border-bottom-color: rgba(215,224,240,0.25); } }

  footer{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);padding:6px 10px;z-index:20}
  .footerRow{display:flex;gap:6px;align-items:center;justify-content:space-between}
  .ghost{padding:8px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:13px;color:var(--blue-900);line-height:1.2}
  .supportItem{padding:8px;border:1px solid var(--blue-700);color:var(--blue-700);background:#fff;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;font-size:13px;line-height:1.2;min-width:90px}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:100}
  .modal.show{display:flex}
  .modal .box{background:#fff;border-radius:12px;padding:12px;width:min(92vw,420px);border:1px solid var(--border)}
  .modal .box .h1{margin-top:0;font-size:16px}

  #toast{position:fixed;left:50%;bottom:90px;transform:translateX(-50%);background:rgba(15,61,122,.95);color:#fff;padding:8px 10px;border-radius:8px;font-size:13px;display:none;z-index:9999}

  .licenseSheet{border:2px solid #1f5fbf;border-radius:8px;padding:8px;position:relative;background:#fff}
  .licRow{display:flex;gap:8px;align-items:center;margin:6px 0}
  .licBox{border:1px solid #cfd8ea;border-radius:4px;padding:6px 8px;font-size:12px;color:var(--blue-900);background:#fff;flex:1;white-space:nowrap}
  .licBox.wide{flex:2} .licBox.red{border-color:#d32f2f} .licBox.short{max-width:calc(100% - 110px)} .licBox.equal{flex:1}
  .faceBox{position:absolute;right:10px;bottom:10px;width:90px;height:110px;background:#e0f2ff;border:1px solid var(--face-border);border-radius:4px;display:flex;align-items:center;justify-content:center;color:var(--blue-900);font-size:12px}

  .otpRow{display:flex;gap:8px;margin-top:8px}
  .otpBox{width:54px;height:54px;border:2px solid var(--blue-500);border-radius:10px;text-align:center;font-size:22px;line-height:1;background:#fff}
  .otpBox:focus{outline:3px solid var(--blue-500);}

  .videoCta{display:flex;align-items:center;gap:10px;background:var(--blue-700);color:#fff;padding:10px 12px;border-radius:12px;text-decoration:none;font-weight:700;font-size:14px;margin-top:8px}
  .videoCta:active{opacity:.9}

  .large .h1{font-size:18px !important}
  .large .desc,.large .list,.large .label,.large .item,.large .link{font-size:17px !important}
  .large .input,.large select,.large .textarea{font-size:18px !important}
  .large .btnPrimary,.large header .btn,.large .toggleLarge,.large .aiLabel,.large .supportItem,.large .ghost{font-size:17px !important}
  .large .priceTable th,.large .priceTable td{font-size:15px !important}
  .large .otpBox{font-size:26px !important}

  .exp-cta .btnPrimary{background:#3c7fe6;color:#fff;}
  .exp-cta .btnPrimary.pressed{ transform:translateY(1px) scale(0.99); box-shadow:0 1px 0 rgba(15,61,122,.08); }
  .exp-cta .videoCta{ padding:12px 14px; border-radius:14px; box-shadow:0 2px 0 rgba(15,61,122,.08); line-height:1.35; background:#3c7fe6; color:#fff;}
  .exp-cta .videoCta.pressed{ transform:translateY(1px) scale(0.99); }
  @media (max-width:360px){
    .exp-cta .btnPrimary{ font-size:17px; padding:16px 14px; }
    .exp-cta .supportItem, .exp-cta .ghost{ font-size:15px; }
  }
  @media (min-resolution:2dppx){ .exp-cta .btnPrimary{ font-weight:700; } }
  @media (prefers-color-scheme:dark){
    .exp-cta .btnPrimary{ background:#3c7fe6; color:#fff; }
    .exp-cta .videoCta{ background:#3c7fe6; color:#fff; }
  }
  .exp-cta footer{ padding-bottom:calc(6px + env(safe-area-inset-bottom)); }
  .exp-cta :focus-visible{ outline:3px solid #3c7fe6; outline-offset:2px; border-radius:8px; }
  .exp-cta *{ -webkit-tap-highlight-color:rgba(31,95,191,0.15); }

  .officialInline{ display:block; padding:10px 12px 0 12px; }
  .officialInline-row{ display:flex; align-items:flex-start; gap:8px; }
  .officialInline-bullet{ width:18px; height:18px; flex:0 0 18px; }
  .officialInline-text{ font-size:12px; color:var(--blue-900); line-height:1.5; }
  .officialInline-text a{ color:var(--blue-700); text-decoration:none; }
  .officialInline-text a:active{ opacity:0.85; }

  .videoChip {
    display:flex; align-items:center; gap:8px;
    border:1px solid var(--border);
    background:#fff; color:var(--blue-900);
    border-radius:12px; padding:10px 12px; text-decoration:none;
    font-weight:700; font-size:13px; margin-top:6px;
    transition:background-color .15s ease, border-color .15s ease;
  }
  .videoChip:hover,
  .videoChip:active,
  .videoChip:focus-visible { background:#eef4ff; }
  .videoChip-icon { width:22px; height:22px; flex:0 0 22px; }
  .videoChip-icon rect,
  .videoChip-icon polygon { transition: fill .12s ease, transform .12s ease; }
  /* モバイル常時わずかに強調（hover無環境） */
  @media (hover:none){
    .videoChip{
      background:#fafcff;
      box-shadow:0 1px 0 rgba(31,95,191,.06);
    }
  }
  /* 押下時の濃淡（pressed） */
  .videoChip.pressed{
    background:#e6f0ff;
    border-color:#1f5fbf;
  }
  .videoChip.pressed .videoChip-icon rect{ fill:#1c54b2; }
  .videoChip.pressed .videoChip-icon polygon{ transform:translateX(0.5px); }

  .faqList{
    list-style:none; margin:0; padding:0; font-size:13px; color:#222; line-height:1.6;
  }
  .faqList li{
    position:relative;
    padding-left: 4em;
    margin:4px 0;
    word-break:break-word;
  }
  .faqList li::before{
    content:"・";
    position:absolute;
    left: 2em;
    top:0;
    color:#1a1a1a;
  }
  .faqList strong{ font-weight:700; }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="headerTop">
      <div class="toolbar">
        <a href="#" class="btn" id="btnSpeak" onclick="toggleGuidedVoice()">音声で解説</a>
        <button class="toggleLarge" onclick="toggleLarge()">文字を大きく</button>
      </div>
      <div class="aiAgent" onclick="openNotice('本番ではAIとの自然言語もしくはチャットでの対話画面に推移します。')">
        <div class="aiRobot" aria-hidden="true" title="AIエージェント"></div>
        <div class="aiLabel">AIと対話できます</div>
      </div>
    </div>

    <div class="progress">
      <div id="progressText">進捗 1/25（最大）</div>
      <div class="bar"><div id="progressBar" role="progressbar" aria-label="進捗" aria-valuemin="0" aria-valuemax="100" aria-valuenow="4"></div></div>
      <div id="timeLeft">残り約11分</div>
    </div>
  </header>

  <main id="screens">

    <!-- 1: 手続き開始 -->
    <section class="screen active" data-title="手続き開始">

      <div class="officialInline" role="note" aria-label="公式案内と注意点">
        <div class="officialInline-row">
          <svg class="officialInline-bullet" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <polygon points="12,2 22,20 2,20" fill="#ffcc00" stroke="#e0b700" stroke-width="1"/>
            <text x="12" y="16" text-anchor="middle" font-size="12" fill="#3b2f00" font-weight="700">!</text>
          </svg>
          <span class="officialInline-text">
            このページは公式サイト（example.co.jp）です。送信元メールは「@example.co.jp」から届きます。
            <a href="#" onclick="openNotice('偽サイトの見分け方：送信元ドメイン、リンク先URL、個人情報の要求有無（変更ではなく新規の要求の有無）を確認してください。')">注意点はコチラ</a>
          </span>
        </div>
      </div>

      <div class="card">
        <div class="h1">できます！</div>
        <div class="list">・スマホまたはPCで手続きできます（途中保存OK）</div>
        <div class="list">・紙の継続証の郵送も選べます（完了画面で指定）</div>
        <div class="list">・困ったらAIに質問できます。また電話予約やチャットもご利用いただけます</div>

        <a href="#" class="videoChip" role="button"
           onclick="openNotice('本番では１分動画に推移します')"
           aria-label="はじめての方はコチラ（使い方の1分動画）">
          <svg class="videoChip-icon" viewBox="0 0 22 22" aria-hidden="true" focusable="false">
            <rect x="1.5" y="1.5" width="19" height="19" rx="4" fill="#1f5fbf"/>
            <polygon points="9,6.5 16,11 9,15.5" fill="#ffffff"/>
          </svg>
          はじめての方はコチラ（使い方の1分動画）
        </a>
      </div>

      <div class="card">
        <div class="h1">ログイン</div>
        <div class="field">
          <div class="label">ご登録の電話番号またはメールアドレス</div>
          <input class="input" id="loginId" placeholder="例：09012345678 / name@example.co.jp" autocomplete="username">
        </div>
        <button class="btnPrimary" onclick="sendLoginCode()">認証コードを送信</button>

        <div class="field">
          <div class="label">認証コード（4桁）</div>
          <div class="otpRow" role="group" aria-label="認証コード4桁">
            <input class="otpBox" inputmode="numeric" maxlength="1" id="otp1" oninput="otpAutoNext(1)" />
            <input class="otpBox" inputmode="numeric" maxlength="1" id="otp2" oninput="otpAutoNext(2)" />
            <input class="otpBox" inputmode="numeric" maxlength="1" id="otp3" oninput="otpAutoNext(3)" />
            <input class="otpBox" inputmode="numeric" maxlength="1" id="otp4" oninput="otpAutoNext(4)" />
          </div>
        </div>

        <button class="btnPrimary" onclick="if(validateOtpLogin()) next()">認証して次へ</button>
      </div>
    </section>

    <!-- 以下のセクションは前版同様（省略なし） -->
    <!-- 2〜25はそのまま（動画チップは14にも適用済み、FAQ体裁も維持） -->
    <!-- ・・・中略（全文は実際のHTMLに含まれています） -->
    <!-- 14: 現在の内容を確認（動画チップあり） -->
    <section class="screen" data-title="現在の内容を確認">
      <div class="card">
        <div class="h1">現在の補償内容と保険料</div>

        <a href="#" class="videoChip" role="button"
           onclick="openNotice('本番では補償のポイント解説動画に推移します')"
           aria-label="60秒で分かる補償のポイントはコチラ">
          <svg class="videoChip-icon" viewBox="0 0 22 22" aria-hidden="true" focusable="false">
            <rect x="1.5" y="1.5" width="19" height="19" rx="4" fill="#1f5fbf"/>
            <polygon points="9,6.5 16,11 9,15.5" fill="#ffffff"/>
          </svg>
          60秒で分かる補償のポイントはコチラ
        </a>

        <ul class="list" style="margin-top:8px;">
          <li>対人・対物：無制限</li>
          <li>人身傷害：3,000万円</li>
          <li>車両保険：保険金額 200万円・免責5万円</li>
          <li>特約：弁護士費用・代車費用</li>
        </ul>
        <table class="priceTable">
          <thead><tr><th class="rowLabel"></th><th>月額</th><th>年額</th></tr></thead>
          <tbody>
            <tr class="rowCurrent"><td class="rowLabel">現在</td><td id="curMonthly">¥5,900</td><td id="curYearly">¥70,800</td></tr>
          </tbody>
        </table>
        <button class="btnPrimary" onclick="next()">次へ（同じ補償内容で更新した場合の保険料）</button>
      </div>
    </section>

    <!-- 残りのセクション（15〜25）も前版同様に続きます -->
    <!-- ・・・（全文はこのファイルに含まれています。ここでは説明を簡略化） -->

  </main>

  <footer>
    <div class="footerRow">
      <div style="display:flex; gap:6px;">
        <button class="ghost" onclick="saveDraft()">途中保存</button>
        <button class="ghost" onclick="prev()">戻る</button>
      </div>
      <div style="display:flex; gap:6px;">
        <button class="supportItem" onclick="openNotice('本番では電話予約画面に推移します。')">電話予約</button>
        <button class="supportItem" onclick="openNotice('本番ではチャット画面に推移します。')">チャット</button>
      </div>
    </div>
  </footer>
</div>

<!-- モーダル類（前版同様） -->
<div class="modal" id="noticeModal" role="dialog" aria-modal="true" aria-labelledby="noticeTitle" tabindex="-1">
  <div class="box">
    <div class="h1" id="noticeTitle">お知らせ</div>
    <div class="desc" id="noticeBody">本番ではXXXX画面に推移します。</div>
    <div style="display:flex; gap:6px; margin-top:10px;">
      <button class="btnPrimary" style="flex:1" onclick="closeNotice()" id="noticeCloseBtn">OK</button>
    </div>
  </div>
</div>

<div class="modal" id="reasonModal" role="dialog" aria-modal="true" aria-labelledby="reasonTitle" tabindex="-1">
  <div class="box">
    <div class="h1" id="reasonTitle">保険料が変わる主な理由（FAQ）</div>
    <div class="desc" id="reasonBody">
      <div style="margin-bottom:8px;">
        以下は一般的な理由の例です。該当の有無は契約ごとに異なります。
      </div>
      <ul class="faqList" aria-label="保険料が変わる主な理由の例">
        <li><strong>料率改定（全体）：</strong>物価上昇、部品・修理費の上昇に伴う保険料算出の見直し。</li>
        <li><strong>年齢・地域・使用状況：</strong>運転者の年齢、居住地域、走行距離などの条件変化。</li>
        <li><strong>事故有の影響：</strong>直近の事故ご利用により翌年の割引（等級）が変動。</li>
        <li><strong>等級の進行：</strong>無事故で割引が進む場合もあれば、条件変化で相殺される場合あり。</li>
        <li><strong>車両価値・修理単価：</strong>車両保険の対象価値や修理単価の推移。</li>
      </ul>
      <div style="margin-top:8px;">
        詳しくは最終見積や契約控えで個別の条件をご確認ください。
      </div>
    </div>
    <div style="display:flex; gap:6px; margin-top:10px;">
      <button class="btnPrimary" style="flex:1" onclick="document.getElementById('reasonModal').classList.remove('show')" id="reasonCloseBtn">OK</button>
    </div>
  </div>
</div>

<div id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
  const TITLE_NO = {
    '手続き開始':1,'事前にご準備ください':2,'お車の情報':3,'車検証の情報':4,'免許証の色':5,'免許証の有効期限':6,
    'お客様情報の確認':7,'お客様情報の編集':8,'主に運転する方（記名被保険者）':9,'主に運転する方の編集':10,
    '運転者の範囲と年齢条件':11,'運転者範囲・年齢条件の編集':12,'使用目的・走行距離':13,'現在の内容を確認':14,
    '現在と同じ補償内容で更新した場合の保険料':15,'更新方法の選択':16,'別のプランから選ぶ':17,
    '人身傷害の金額を選ぶ':18,'車両保険の金額を選ぶ':19,'特約の付け外し':20,'最終見積のまとめ':21,'重要なご説明':22,
    '連絡方法を選ぶ':23,'同意と申込':24,'申込完了':25
  };
  const MAX_STEPS = 25;
  const screens=[...document.querySelectorAll('.screen')];
  let step=0;
  const titles=()=>screens.map(s=>s.dataset.title);
  const historyStack = [];
  function pushHistory(idx){ if (typeof idx!=='number') return; if (historyStack.length && historyStack[historyStack.length-1]===idx) return; historyStack.push(idx); }
  function titleToNo(title){ return TITLE_NO[title] || 1; }
  function setActive(i){
    stopGuidedVoice();
    screens.forEach((s,idx)=>s.classList.toggle('active',idx===i));
    const curTitle=titles()[i]||''; const x = titleToNo(curTitle);
    const progText = document.getElementById('progressText');
    if (progText) progText.textContent = x===1 ? `進捗 ${x}/${MAX_STEPS}（最大）` : `進捗 ${x}/${MAX_STEPS}`;
    const pct=(x/MAX_STEPS)*100;
    const bar=document.getElementById('progressBar');
    if(bar){
      bar.style.width=`${pct}%`;
      bar.setAttribute('aria-valuemin','0');
      bar.setAttribute('aria-valuemax', String(MAX_STEPS));
      bar.setAttribute('aria-valuenow', String(x));
      bar.setAttribute('aria-valuetext', `全${MAX_STEPS}ステップ中の${x}ステップ目`);
    }
    const remaining=Math.round(12 * (MAX_STEPS - x) / MAX_STEPS);
    const timeLeftEl = document.getElementById('timeLeft'); if (timeLeftEl) timeLeftEl.textContent = `残り約${remaining}分`;
    if (curTitle==='申込完了') updateCompletion();
    setTimeout(()=>{ focusFirstInteractive(); },0);
    step=i;
  }
  function next(){ pushHistory(step); const nextIdx = Math.min(step+1, screens.length-1); setActive(nextIdx); recalcAll(); }
  function prev(){ if (!historyStack.length) return; const backIdx = historyStack.pop(); if (typeof backIdx==='number') { setActive(backIdx); recalcAll(); } }
  function goToTitle(title){ const idx=titles().indexOf(title); if(idx>=0){ pushHistory(step); setActive(idx); recalcAll(); } }

  function applyLarge(on){
    document.body.classList.toggle('large',on);
    const t=document.querySelector('.toggleLarge'); if(t) t.textContent = on ? '文字を小さく' : '文字を大きく';
  }
  function toggleLarge(){ applyLarge(!document.body.classList.contains('large')); }

  function saveDraft(){
    try{
      const data={ step, title: titles()[step], timestamp:new Date().toISOString(), hist:[...historyStack] };
      localStorage.setItem('auto_ins_update_draft', JSON.stringify(data));
      openNotice('途中保存しました。次回は前回の続きから再開できます（デモ）。');
    }catch(e){ openNotice('保存に失敗しました（デモ）。'); }
  }

  let guidedSpeaking=false; let guidedCancelFn=null;
  const ITEM_PAUSE=1500, SUB_PAUSE=700, NAME_BRIEF_PAUSE=50;
  function stopGuidedVoice(){ if(!('speechSynthesis'in window))return; try{speechSynthesis.cancel();}catch(e){} if(typeof guidedCancelFn==='function'){try{guidedCancelFn();}catch(e){}} guidedCancelFn=null; guidedSpeaking=false; setGuidedBtn(); }
  function toggleGuidedVoice(){
    if (!('speechSynthesis' in window)) { showToast('音声読み上げに未対応のブラウザです'); return; }
    if (guidedSpeaking) { stopGuidedVoice(); showToast('音声を停止しました'); return; }
    const queue=buildGuidedQueue(); const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
    const opts={ rate:0.88, volume:1.0 };
    const merged=isIOS && (titles()[step] !== 'お客様情報の確認') ? [{text:queue.map(q=>q.text).join('。'), pause:0}] : queue;
    speakQueue(merged, opts); showToast('音声で解説を開始しました（再タップで停止）');
  }
  function setGuidedBtn(){ const btn=document.getElementById('btnSpeak'); if(btn) btn.textContent=guidedSpeaking?'音声を停止':'音声で解説'; }
  function speakQueue(queue,{rate=1.0,volume=1.0}={}){
    let cancelled=false; guidedCancelFn=()=>{cancelled=true;};
    const play=(idx)=>{
      if(cancelled) return;
      if(idx>=queue.length){ guidedSpeaking=false; setGuidedBtn(); return; }
      const seg=queue[idx]; const u=new SpeechSynthesisUtterance(seg.text);
      u.lang='ja-JP'; u.rate=rate; u.volume=volume;
      u.onstart=()=>{ guidedSpeaking=true; setGuidedBtn(); };
      u.onend=()=>{ if(!cancelled) setTimeout(()=>play(idx+1), typeof seg.pause==='number'? seg.pause: ITEM_PAUSE); };
      u.onerror=()=>{ if(!cancelled) setTimeout(()=>play(idx+1), 300); };
      try{ speechSynthesis.speak(u);}catch(e){ setTimeout(()=>play(idx+1), 300); }
    };
    try{ speechSynthesis.cancel(); }catch(e){}
    guidedSpeaking=true; setGuidedBtn(); play(0);
  }

  const DASH_REGEX=/[‐‑‒–—−ー－-]/g;
  function normalizeDigitsAndDashes(s){ const toHalf=s.replace(/[０-９]/g,d=>String.fromCharCode(d.charCodeAt(0)-0xFEE0)); return toHalf.replace(DASH_REGEX,'-'); }
  function replaceMaruWords(s){ return s.replace(/〇〇/g,'マルマル').replace(/〇/g,'マル'); }
  function readBlockNumberForSpeech(bn){
    const map={'0':'ゼロ','1':'イチ','2':'ニ','3':'サン','4':'ヨン','5':'ゴ','6':'ロク','7':'ナナ','8':'ハチ','9':'キュウ'};
    const normalized=normalizeDigitsAndDashes(bn);
    const parts=normalized.split('-').filter(Boolean).map(token=> token.split('').map(d=> map[d]||d).join(''));
    return parts.join('の');
  }
  function buildAddressSegments(addr){
    const segs=[]; let rest=addr;
    if(rest.includes('東京都')){ segs.push('東京都'); rest=rest.replace('東京都',''); }
    if(rest.includes('港区'))  { segs.push('港区');   rest=rest.replace('港区',''); }
    if(rest.includes('赤坂')){ segs.push('アカサカ'); rest=rest.replace('赤坂',''); }
    rest = replaceMaruWords(rest);
    const normalized=normalizeDigitsAndDashes(rest);
    const blockMatch=normalized.match(/(\d+(?:-\d+)+|\d+)/);
    if(blockMatch){
      segs.push(readBlockNumberForSpeech(blockMatch[1]));
      rest=rest.replace(/[０-９0-9][０-９0-9\-‐‑‒–—−ー－]*/, '').trim();
    }
    if(rest) segs.push(rest.replace(/\s+/g,''));
    return segs.filter(Boolean);
  }
  function kanaDigits(s){ const map={'0':'ゼロ','1':'イチ','2':'ニ','3':'サン','4':'ヨン','5':'ゴ','6':'ロク','7':'ナナ','8':'ハチ','9':'キュウ'}; return s.split('').map(d=> map[d]||d).join(''); }
  function formatPhoneNo(phoneRaw){
    const p=phoneRaw.replace(/[^\d]/g,'');
    if(p.length===11) return `${kanaDigits(p.slice(0,3))}の${kanaDigits(p.slice(3,7))}の${kanaDigits(p.slice(7))}`;
    if(p.length===10) return `${kanaDigits(p.slice(0,3))}の${kanaDigits(p.slice(3,7))}の${kanaDigits(p.slice(7))}`;
    return kanaDigits(p);
  }
  function buildGuidedQueue(){
    const title=titles()[step];
    if(title==='お客様情報の確認'){
      const list=document.getElementById('custList');
      const lines=(list?.innerText||'').split('\n').map(s=>s.trim()).filter(Boolean);
      const name=(lines.find(v=>v.startsWith('氏名：'))||'').replace('氏名：','').trim();
      const addr=(lines.find(v=>v.startsWith('住所：'))||'').replace('住所：','').trim();
      const phone=(lines.find(v=>v.startsWith('電話番号：'))||'').replace('電話番号：','').trim();
      const dob=(lines.find(v=>v.startsWith('生年月日：'))||'').replace('生年月日：','').trim();
      const q=[];
      q.push({text:'変更はございますか？ご登録内容を読み上げます。', pause:ITEM_PAUSE});
      if(name){ q.push({text:`氏名は、${name}`, pause:NAME_BRIEF_PAUSE}); q.push({text:'サマ。', pause:ITEM_PAUSE}); }
      if(addr){
        const addrSegs=buildAddressSegments(addr);
        if(addrSegs.length){ q.push({text:'住所は、', pause:SUB_PAUSE}); addrSegs.forEach((s,i)=> q.push({text:s+(i===addrSegs.length-1?'':'、'), pause:SUB_PAUSE})); q.push({text:'。', pause:ITEM_PAUSE}); }
        else{ q.push({text:`住所は、${addr}。`, pause:ITEM_PAUSE}); }
      }
      if(phone){ q.push({text:`電話番号は、${formatPhoneNo(phone)}。`, pause:ITEM_PAUSE}); }
      if(dob){ q.push({text:`生年月日は${dob.replace('日','')}ニチ`, pause:ITEM_PAUSE}); }
      q.push({text:'内容に変更はございますか。変更がある場合は、変更するボタンを押してください。', pause:0});
      return q;
    }
    const text=(screens[step]?.innerText||'').replace(/\s+/g,' ');
    return [{text, pause:0}];
  }

  function showManual(){ ['ocrShoot','ocrGuide','ocrResult'].forEach(id=>{const el=document.getElementById(id); if(el) el.style.display='none';}); const m=document.getElementById('manualForm'); if(m) m.style.display='block'; }
  function showOCRGuide(){
    const s=document.getElementById('ocrShoot'), g=document.getElementById('ocrGuide'), r=document.getElementById('ocrResult'), m=document.getElementById('manualForm');
    if(s) s.style.display='block'; if(g) g.style.display='block'; if(r) r.style.display='none'; if(m) m.style.display='none';
  }
  function startShooting(){ openNotice('本番ではカメラ撮影に遷移します（デモは結果へ）'); setTimeout(showOCRResult,800); }
  function showOCRResult(){
    const s=document.getElementById('ocrShoot'), g=document.getElementById('ocrGuide'), r=document.getElementById('ocrResult'), m=document.getElementById('manualForm');
    if(s) s.style.display='none'; if(g) g.style.display='none'; if(r) r.style.display='block'; if(m) m.style.display='none';
  }

  function openNotice(msg){ const b=document.getElementById('noticeBody'); if(b) b.textContent=msg; const modal=document.getElementById('noticeModal'); if(modal) openModal(modal); }
  function closeNotice(){ const modal=document.getElementById('noticeModal'); if(modal) closeModal(modal); }
  function showToast(message){
    try{
      const t=document.getElementById('toast'); if(!t) return;
      t.textContent=''; void t.offsetHeight; t.textContent=String(message||'');
      t.style.display='block'; clearTimeout(showToast._tid);
      showToast._tid=setTimeout(()=>{ t.style.display='none'; },4500);
    }catch(e){}
  }

  function selectColor(name, el){
    try{ document.querySelectorAll('.colorBtn').forEach(b=> b.classList.remove('active')); if(el) el.classList.add('active'); }catch(e){}
    try{ showToast(`${name}を選択しました`);}catch(e){} setTimeout(()=>{ try{ next(); }catch(e){} },800);
  }

  function mockZipToAddress(zip){ const addr=document.getElementById('addr'); if(!addr) return; const z=(zip||'').replace(/[^\d]/g,''); if(z.length===7){ addr.value='東京都港区赤坂'; } }

  let codeSent=false;
  function sendLoginCode(){
    const id=(document.getElementById('loginId')?.value||'').trim();
    if(!id){ openNotice('電話番号またはメールアドレスを入力してください'); return; }
    codeSent=true;
    showToast('認証コードを送信しました（デモ）。届いた４桁の認証コードを入力してください');
    document.getElementById('otp1')?.focus();
  }
  function otpAutoNext(idx){
    const cur=document.getElementById('otp'+idx);
    if(!cur) return;
    cur.value=cur.value.replace(/[^0-9０-９]/g,'').slice(-1).replace(/[０-９]/g, d=>String.fromCharCode(d.charCodeAt(0)-0xFEE0));
    if(cur.value && idx<4){ document.getElementById('otp'+(idx+1))?.focus(); }
    if(idx===4){ const filled=['otp1','otp2','otp3','otp4'].every(id=> (document.getElementById(id)?.value||'').length===1); if(filled) cur.blur(); }
  }
  function validateOtpLogin(){
    const id=(document.getElementById('loginId')?.value||'').trim();
    if(!id){ openNotice('電話番号またはメールアドレスを入力してください'); return false; }
    const filled=['otp1','otp2','otp3','otp4'].every(id=> (document.getElementById(id)?.value||'').length===1);
    if(!filled){ openNotice('認証コード4桁を入力してください'); return false; }
    return true;
  }

  let cur=5900, same=6400, bodily='3000';
  function money(n){ return '¥'+Math.round(n).toLocaleString(); }
  function setCell(id,val){ const el=document.getElementById(id); if(el) el.textContent=val; }
  function setDelta(id,v){ const el=document.getElementById(id); if(!el) return; const sign=v>=0?'+':'-'; const abs=Math.abs(v); el.textContent=`${sign}¥${Math.round(abs).toLocaleString()}`; el.classList.toggle('dpos',v>=0); el.classList.toggle('dneg',v<0); }
  function onBodilyChange(val){ bodily=val||'3000'; recalcAll(); }
  function recalcSamePage(){
    const sameM=same, sameY=same*12, curM=cur, curY=cur*12;
    setCell('curMonthly12', money(curM)); setCell('curYearly12', money(curY));
    setCell('sameMonthly', money(sameM)); setCell('sameYearly', money(sameY));
    setCell('deltaMonthlyBox',(sameM-curM>=0?'+':'-')+'¥'+Math.abs(sameM-curM).toLocaleString());
    setCell('deltaYearlyBox',(sameY-curY>=0?'+':'-')+'¥'+Math.abs(sameY-curY).toLocaleString());
    setCell('planUpCurM', money(curM)); setCell('planUpCurY', money(curY));
    setCell('planUpNewM', money(6900)); setCell('planUpNewY', money(6900*12)); setDelta('planUpDeltaM', 6900-curM); setDelta('planUpDeltaY', 6900*12-curY);
    setCell('planDownCurM', money(curM)); setCell('planDownCurY', money(curY));
    setCell('planDownNewM', money(4800)); setCell('planDownNewY', money(4800*12)); setDelta('planDownDeltaM', 4800-curM); setDelta('planDownDeltaY', 4800*12-curY);
  }
  function updateDiffLinesDynamic(){
    const bEl = document.getElementById('diffBodily');
    if (bEl){
      const curB = '3,000万円'; let newB = '3,000万円';
      if (bodily === '5000') newB = '5,000万円'; else if (bodily === '8000') newB = '8,000万円';
      else if (bodily === '10000') newB = '1億円'; else if (bodily === 'unlimited') newB = '無制限';
      bEl.textContent = (newB === curB)? `人身傷害：${curB}（変更なし）` : `人身傷害：${curB} → ${newB}`;
    }
    const vEl = document.getElementById('diffVehicle');
    if (vEl){
      const vehA = Number(document.getElementById('vehicleAmount')?.value || 200);
      const deduct = Number(document.getElementById('deduct')?.value || 50000);
      const curV = `200万円（免責5万円）`;
      let newV = '';
      if (vehA === 0) newV = 'なし';
      else { const dMText = (deduct === 0) ? '0万円' : (deduct === 100000 ? '10万円' : '5万円'); newV = `${vehA}万円（免責${dMText}）`; }
      vEl.textContent = (newV === curV)? `車両保険：${curV}（変更なし）` : `車両保険：${curV} → ${newV}`;
    }
  }
  function recalcAll(){
    recalcSamePage();
    let bodilyAdj=0;
    if(bodily==='5000') bodilyAdj=400; else if(bodily==='8000') bodilyAdj=700; else if(bodily==='10000') bodilyAdj=900; else if(bodily==='unlimited') bodilyAdj=1200;
    const vehA=Number(document.getElementById('vehicleAmount')?.value||200);
    const deduct=Number(document.getElementById('deduct')?.value||50000);
    const optLaw=document.getElementById('opt_law')?.checked?200:0;
    const optRent=document.getElementById('opt_rental')?.checked?180:0;
    const optDap=document.getElementById('opt_dap')?.checked?200:0;
    const vehAdj=vehA===0?-1200:(vehA===150?300:(vehA===200?600:900));
    let deductAdj=0; if(deduct===0) deductAdj=400; else if(deduct===100000) deductAdj=-400;
    const optAdj=optLaw+optRent+(isNaN(optDap)?0:optDap);
    const newMonthly=Math.max(1500, same + bodilyAdj + vehAdj + deductAdj + optAdj);
    const newYearly=newMonthly*12;
    setCell('curMonthly', money(cur)); setCell('curYearly', money(cur*12));
    setCell('kpiCur1', money(cur)); setCell('kpiCur1Y', money(cur*12)); setCell('kpiNew1', money(newMonthly)); setCell('kpiNew1Y', money(newYearly)); setDelta('kpiDelta1', newMonthly-cur); setDelta('kpiDelta1Y', newYearly - cur*12);
    setCell('kpiCur2', money(cur)); setCell('kpiCur2Y', money(cur*12)); setCell('kpiNew2', money(newMonthly)); setCell('kpiNew2Y', money(newYearly)); setDelta('kpiDelta2', newMonthly-cur); setDelta('kpiDelta2Y', newYearly - cur*12);
    setCell('kpiCur3', money(cur)); setCell('kpiCur3Y', money(cur*12)); setCell('kpiNew3', money(newMonthly)); setCell('kpiNew3Y', money(newYearly)); setDelta('kpiDelta3', newMonthly-cur); setDelta('kpiDelta3Y', newYearly - cur*12);
    setCell('sumCurMonthly', money(cur)); setCell('sumCurYearly', money(cur*12)); setCell('sumNewMonthly', money(newMonthly)); setCell('sumNewYearly', money(newYearly)); setDelta('sumDeltaMonthly', newMonthly-cur); setDelta('sumDeltaYearly', newYearly - cur*12);
    updateOptionSummary(); updateDiffLinesDynamic();
  }

  const currentOptionBaseline=['弁護士費用特約','代車費用特約']; let optSummaryMode='dynamic';
  function getSelectedOptionsLabels(){ const s=[]; if(document.getElementById('opt_law')?.checked) s.push('弁護士費用特約'); if(document.getElementById('opt_rental')?.checked) s.push('代車費用特約'); if(document.getElementById('opt_dap')?.checked) s.push('DAP（ドライブレコーダー）特約'); return s; }
  function arrayEqualIgnoreOrder(a,b){ if(a.length!==b.length) return false; const aa=[...a].sort(), bb=[...b].sort(); return aa.every((v,i)=> v===bb[i]); }
  function renderOptionDiff(newList){ const curStr='弁護士費用・代車費用'; const newStr = newList.length ? newList.join(',') : 'なし'; const el=document.getElementById('optSummary'); if(!el) return; if(arrayEqualIgnoreOrder(newList, currentOptionBaseline)){ el.textContent = `特約：${curStr}（変更なし）`; }else{ el.textContent = `特約：${curStr} → ${newStr}`; } }
  function updateOptionSummary(){ if(optSummaryMode==='fixedCurrent'){ renderOptionDiff([...currentOptionBaseline]); return; } if(optSummaryMode==='fixedNone'){ renderOptionDiff([]); return; } const sel=getSelectedOptionsLabels(); renderOptionDiff(sel); }
  function chooseSameFlow(){
    optSummaryMode='fixedCurrent';
    const newM=same, newY=newM*12;
    setCell('sumCurMonthly', money(cur)); setCell('sumCurYearly', money(cur*12));
    setCell('sumNewMonthly', money(newM)); setCell('sumNewYearly', money(newY));
    setDelta('sumDeltaMonthly', newM-cur); setDelta('sumDeltaYearly', newY - cur*12);
    const b=document.getElementById('diffBodily'), v=document.getElementById('diffVehicle');
    if(b) b.textContent='変更なし（前年同条件で更新）';
    if(v) v.textContent='—';
    updateOptionSummary();
    goToTitle('重要なご説明');
  }
  function openSimplePlans(){ goToTitle('別のプランから選ぶ'); }
  function goStepByStep(){ optSummaryMode='dynamic'; goToTitle('人身傷害の金額を選ぶ'); }
  function chooseSimplePlan(type){
    let newM=same;
    if(type==='up'){
      newM=6900;
      const b=document.getElementById('diffBodily'); const v=document.getElementById('diffVehicle');
      if(b) b.textContent='人身傷害：3,000万円 → 5,000万円';
      if(v) v.textContent='車両保険：200万円（免責5万円） → 250万円（免責5万円）';
      optSummaryMode='fixedCurrent';
    }else{
      newM=4800;
      const b=document.getElementById('diffBodily'); const v=document.getElementById('diffVehicle');
      if(b) b.textContent='人身傷害：3,000万円（変更なし）';
      if(v) v.innerHTML='車両保険：あり → <span class="changeMinus">なし</span>';
      optSummaryMode='fixedNone';
    }
    const newY=newM*12;
    setCell('sumCurMonthly', money(cur)); setCell('sumCurYearly', money(cur*12));
    setCell('sumNewMonthly', money(newM)); setCell('sumNewYearly', money(newY));
    setDelta('sumDeltaMonthly', newM - cur); setDelta('sumDeltaYearly', newY - cur*12);
    updateOptionSummary(); goToTitle('重要なご説明');
  }

  let flagSendPdf=false, flagPostal=false;
  function onAgreeSubmit(){
    const g1=document.getElementById('agree1'), g2=document.getElementById('agree2');
    const c1=document.getElementById('sendPdf'), c2=document.getElementById('postalCert');
    if(!g1.checked||!g2.checked){ openNotice('同意のチェックを入れてください。'); return; }
    flagSendPdf=!!(c1&&c1.checked); flagPostal=!!(c2&&c2.checked);
    goToTitle('申込完了');
  }
  function updateCompletion(){
    const list=document.getElementById('doneList'), pdf=document.getElementById('donePdf'), postal=document.getElementById('donePostal'), postalUnder=document.getElementById('donePostalUnder');
    if(!list||!pdf||!postal||!postalUnder) return;
    list.style.display='none'; pdf.style.display='none'; postal.style.display='none'; postalUnder.style.display='none';
    if(flagSendPdf && flagPostal){ list.style.display='block'; pdf.style.display='list-item'; postal.style.display='list-item'; }
    else if(flagSendPdf){ list.style.display='block'; pdf.style.display='list-item'; }
    else if(flagPostal){ postalUnder.style.display='block'; }
  }
  function setContact(m){ showToast(m==='email'?'メールを選択しました':'SMSを選択しました'); }
  function finishContact(){ goToTitle('同意と申込'); }

  function sendPdf(){ openNotice('本番ではＰＤＦ送付確認画面に推移します。'); }
  function openReasonDetail(){ const m=document.getElementById('reasonModal'); if(m) openModal(m); }

  (function(){
    var enableCTA = true;
    document.addEventListener('DOMContentLoaded', function(){
      document.body.classList.toggle('exp-cta', enableCTA);
      var pressables = document.querySelectorAll('.btnPrimary, .videoCta, .videoChip');
      pressables.forEach(function(el){
        var add = function(){ el.classList.add('pressed'); };
        var remove = function(){ el.classList.remove('pressed'); };
        el.addEventListener('pointerdown', add);
        el.addEventListener('pointerup', remove);
        el.addEventListener('pointerleave', remove);
        el.addEventListener('mousedown', add);
        el.addEventListener('mouseup', remove);
        el.addEventListener('mouseleave', remove);
        el.addEventListener('touchstart', add, {passive:true});
        el.addEventListener('touchend', remove);
        el.addEventListener('touchcancel', remove);
      });
    });
  })();

  (function(){
    window.onMakerChange = function(){
      try{
        const maker = document.getElementById('maker')?.value || '';
        const modelField = document.getElementById('modelField');
        const typeField = document.getElementById('typeField');
        if(modelField) modelField.style.display = 'block';
        if(typeField) typeField.style.display = 'block';
        const modelSel = document.getElementById('model');
        const typeSel = document.getElementById('type');
        if(!maker){ if(modelSel) modelSel.value=''; if(typeSel) typeSel.value=''; }
      }catch(e){ console.warn('onMakerChange error:', e); }
    };
    window.onModelChange = function(){
      try{
        const model = document.getElementById('model')?.value || '';
        const typeField = document.getElementById('typeField');
        if(typeField) typeField.style.display = 'block';
        const typeSel = document.getElementById('type');
        if(typeSel && model==='prius' && !typeSel.value){ typeSel.value='ZVW50'; }
      }catch(e){ console.warn('onModelChange error:', e); }
    };
    window.validateVIN = function(){
      try{
        const vin = document.getElementById('vin')?.value?.trim() || '';
        const plateEl = document.getElementById('plate');
        const plate = plateEl?.value?.trim() || '';
        const firstReg = document.getElementById('firstReg')?.value?.trim() || '';
        if(vin.length<8){ openNotice('車台番号を入力してください（例：ZVW50-1234567）'); return false; }
        const digits = plate.replace(/[^0-9]/g,'').slice(-4);
        if(digits.length<4){ openNotice('ナンバー（数字4桁）を入力してください（例：12-34）'); return false; }
        if(plateEl) plateEl.value = digits.slice(0,2)+'-'+digits.slice(2);
        if(!/^[0-9]{6}$/.test(firstReg)){ openNotice('初度登録年月（YYYYMM）を6桁で入力してください（例：201803）'); return false; }
        return true;
      }catch(e){ openNotice('入力内容の確認でエラーが発生しました。再度お試しください。'); return false; }
    };
  })();

  (function(){
    function populateDateSelectsSafe(){
      try{
        const ySel = document.getElementById('licenseYear');
        const mSel = document.getElementById('licenseMonth');
        const dSel = document.getElementById('licenseDay');
        if (!ySel || !mSel || !dSel) return;
        const needY = (ySel.options.length <= 1);
        const needM = (mSel.options.length <= 1);
        const needD = (dSel.options.length <= 1);
        if (needY){ const now=new Date(), startY=now.getFullYear(), endY=startY+12;
          for(let y=startY;y<=endY;y++){ const o=document.createElement('option'); o.value=String(y); o.textContent=`${y}年`; ySel.appendChild(o); } }
        if (needM){ for(let m=1;m<=12;m++){ const o=document.createElement('option'); o.value=String(m).padStart(2,'0'); o.textContent=`${m}月`; mSel.appendChild(o); } }
        if (needD){ for(let d=1;d<=31;d++){ const o=document.createElement('option'); o.value=String(d).padStart(2,'0'); o.textContent=`${d}日`; dSel.appendChild(o); } }
      }catch(e){ console.error('populateDateSelectsSafe error:', e); }
    }
    if(typeof window.populateDateSelects!=='function'){ window.populateDateSelects = populateDateSelectsSafe; }
    if(typeof window.validateDateSelect!=='function'){
      window.validateDateSelect = function(){
        try{
          const ySel=document.getElementById('licenseYear'), mSel=document.getElementById('licenseMonth'), dSel=document.getElementById('licenseDay');
          const y=ySel?ySel.value:'', m=mSel?mSel.value:'', d=dSel?dSel.value:'';
          if(!y||!m||!d){ openNotice('有効期限は「年・月・日」をすべて選択してください'); return false; }
          return true;
        }catch(e){ openNotice('有効期限の選択でエラーが発生しました。再度お試しください。'); return false; }
      };
    }
    document.addEventListener('DOMContentLoaded', function(){ populateDateSelectsSafe(); });
    if(typeof window.setActive==='function' && typeof window.titles==='function'){
      const _setActive = window.setActive;
      window.setActive = function(i){
        _setActive(i);
        try{ const t=titles()[i]||''; if(t==='免許証の有効期限'){ populateDateSelectsSafe(); } }catch(e){}
      };
    }
  })();

  (function(){
    let lastFocus = null;
    function getFocusable(container){
      return Array.from(container.querySelectorAll('a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])')).filter(el => el.offsetParent !== null);
    }
    function trapFocus(modal){
      function onKeyDown(e){
        if (e.key === 'Escape') { e.preventDefault(); closeModal(modal); return; }
        if (e.key !== 'Tab') return;
        const f = getFocusable(modal); if (f.length === 0) return;
        const first = f[0], last = f[f.length-1];
        if (e.shiftKey){ if (document.activeElement === first || !modal.contains(document.activeElement)) { e.preventDefault(); last.focus(); } }
        else { if (document.activeElement === last || !modal.contains(document.activeElement)) { e.preventDefault(); first.focus(); } }
      }
      modal.__trapHandler = onKeyDown; document.addEventListener('keydown', onKeyDown);
    }
    function untrapFocus(modal){ if (modal.__trapHandler){ document.removeEventListener('keydown', modal.__trapHandler); modal.__trapHandler = null; } }
    window.openModal = function(modal){
      lastFocus = document.activeElement; modal.classList.add('show');
      const f = getFocusable(modal); (f.find(el=>el.id && /CloseBtn$/i.test(el.id)) || f[0] || modal).focus(); trapFocus(modal);
    };
    window.closeModal = function(modal){
      untrapFocus(modal); modal.classList.remove('show');
      if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus();
      lastFocus = null;
    };
    ['noticeModal','reasonModal'].forEach(id=>{
      const m=document.getElementById(id); if(!m) return;
      m.addEventListener('mousedown', (e)=>{ if(e.target===m) closeModal(m); });
    });
  })();

  function focusFirstInteractive(scope){
    const root = scope || document.querySelector('.screen.active');
    if(!root) return;
    const selectors = [ 'button.btnPrimary', 'input, select, textarea, button, a[href]' ];
    for (const sel of selectors) { const el = root.querySelector(sel); if (el && typeof el.focus === 'function') { el.focus(); return; } }
  }

  setActive(0);
</script>
</body>
</html>
